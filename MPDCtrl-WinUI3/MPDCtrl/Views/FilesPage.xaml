<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MPDCtrl.Views.FilesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MPDCtrl.Views"
    xmlns:mod="using:MPDCtrl.Models"
    xmlns:vm="using:MPDCtrl.ViewModels"
    xmlns:helper="using:MPDCtrl.Helpers"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=vm:MainViewModel}"
    NavigationCacheMode="Required">

    <Grid x:Name="ContentGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="43"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" x:Name="HeaderGrid" Margin="24,0,24,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Page title -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" x:Uid="PageTitle_Files" FontSize="{StaticResource FontSizePageTitle}" FontWeight="SemiBold"/>
                <TextBlock Grid.Column="1" FontSize="{StaticResource FontSizePageSubTitle}" Text="{x:Bind ViewModel.FilesPageSubTitleFileCount, Mode=OneWay}" VerticalAlignment="Bottom" Padding="48,0,0,4" Opacity="0.7"/>

                <!-- etc buttons-->
                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Bottom">
                    <!-- Filter box -->
                    <StackPanel Orientation="Horizontal" Height="36">
                        <TextBox Name="FilesFilterQueryTextBox" MinWidth="120" Width="180" Text="{x:Bind ViewModel.FilterMusicEntriesQuery, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" Visibility="{x:Bind TglButtonFilesItemsFilter.IsChecked, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}" VerticalAlignment="Bottom" Margin="0,0,6,0"></TextBox>
                        <ToggleButton Name="TglButtonFilesItemsFilter" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="0" Height="36" Click="TglButtonFilesItemsFilter_Click">
                            <Viewbox Width="14" Height="14" Margin="-2,-2,0,0" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <PathIcon Width="NaN" Height="NaN"
								Data="M7.5 13H12.5C12.7761 13 13 13.2239 13 13.5C13 13.7455 12.8231 13.9496 12.5899 13.9919L12.5 14H7.5C7.22386 14 7 13.7761 7 13.5C7 13.2545 7.17688 13.0504 7.41012 13.0081L7.5 13H12.5H7.5ZM5.5 9H14.5C14.7761 9 15 9.22386 15 9.5C15 9.74546 14.8231 9.94961 14.5899 9.99194L14.5 10H5.5C5.22386 10 5 9.77614 5 9.5C5 9.25454 5.17688 9.05039 5.41012 9.00806L5.5 9H14.5H5.5ZM3.5 5H16.5C16.7761 5 17 5.22386 17 5.5C17 5.74546 16.8231 5.94961 16.5899 5.99194L16.5 6H3.5C3.22386 6 3 5.77614 3 5.5C3 5.25454 3.17688 5.05039 3.41012 5.00806L3.5 5H16.5H3.5Z">
                                </PathIcon>
                            </Viewbox>
                            <ToggleButton.KeyboardAccelerators>
                                <KeyboardAccelerator Key="F" Modifiers="Control"/>
                            </ToggleButton.KeyboardAccelerators>
                        </ToggleButton>
                    </StackPanel>
                </StackPanel>
            </Grid>


        </Grid>

        <Grid Grid.Row="1" x:Name="BodyGrid" Margin="24,0,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="6*"/>
            </Grid.ColumnDefinitions>

            <!-- WinUI3 bug: Horizontal scrollbar not visible.
                            https://github.com/microsoft/microsoft-ui-xaml/issues/8825 -->
            <TreeView Grid.Column="0" Margin="0,24,0,0" BorderThickness="0" ItemsSource="{x:Bind ViewModel.MusicDirectories, Mode=OneWay}" SelectionMode="Single" SelectedItem="{x:Bind ViewModel.SelectedNodeDirectory, Mode=TwoWay}" ScrollViewer.HorizontalScrollBarVisibility="Auto"  ScrollViewer.VerticalScrollBarVisibility="Auto">
                <TreeView.ItemTemplate>
                    <DataTemplate x:DataType="mod:NodeTree">
                        <TreeViewItem ItemsSource="{x:Bind Path=Children}" IsExpanded="{x:Bind Path=Expanded, Mode=TwoWay}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Viewbox Grid.Column="0" Width="18" Height="18">
                                    <PathIcon Width="NaN" Height="NaN" Margin="0 0 4 2" Data="{x:Bind Path=PathIcon, Mode=OneWay}"/>
                                </Viewbox>
                                <TextBlock Grid.Column="1" Text="{x:Bind Path=Name, Mode=OneWay}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" Padding="4"/>
                            </Grid>
                        </TreeViewItem>
                    </DataTemplate>
                </TreeView.ItemTemplate>

                <TreeView.ItemContainerStyle>
                    <!--  BasedOn="{StaticResource MUX_TreeViewItemStyle}" Where is DefaultTreeViewItemStyle?? -->
                    <Style TargetType="TreeViewItem">
                        <Setter Property="MinHeight" Value="{ThemeResource TreeViewItemMinHeight}" />
                        <Setter Property="IsExpanded" Value="True" />
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="VerticalAlignment" Value="Center" />
                        
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0" />
                        <!-- Not possible in winui3?
                        
                        <Setter Property="IsSelected" Value="{x:Bind IsSelected, Mode=TwoWay}" />
                        <Setter Property="Height" Value="48" />
                        
                        -->
                    </Style>
                </TreeView.ItemContainerStyle>
            </TreeView>

            <Grid Grid.Column="1" Margin="0,14,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Page controls -->
                <Grid Grid.Row="0" Margin="12,12,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Play and AddTo buttons -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <!-- Play -->
                        <Button Margin="0,0,8,0" Height="36" Command="{x:Bind ViewModel.SelectedDirectoryPlayAllCommand, Mode=OneWay}" CommandParameter="{x:Bind ViewModel.MusicEntriesFiltered, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal">
                                <Viewbox Width="14" Height="14">
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M5.74514 3.06445C5.41183 2.87696 5 3.11781 5 3.50023V12.5005C5 12.8829 5.41182 13.1238 5.74512 12.9363L13.7454 8.43631C14.0852 8.24517 14.0852 7.75589 13.7454 7.56474L5.74514 3.06445ZM4 3.50023C4 2.35298 5.2355 1.63041 6.23541 2.19288L14.2357 6.69317C15.2551 7.26664 15.2551 8.73446 14.2356 9.3079L6.23537 13.8079C5.23546 14.3703 4 13.6477 4 12.5005V3.50023Z"/>
                                </Viewbox>
                                <TextBlock x:Uid="PageMenu_PlayAll" Margin="8,0,6,0" FontSize="{StaticResource FontSizePageMenuControlText}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <!-- Add to queue-->
                        <Button Margin="8,0,8,0" Height="36" Command="{x:Bind ViewModel.SelectedDirectoryAddToQueueCommand}" CommandParameter="{x:Bind ViewModel.MusicEntriesFiltered, Mode=OneWay}" >
                            <StackPanel Orientation="Horizontal">
                                <Viewbox Width="14" Height="14">
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M8 2C8.27614 2 8.5 2.22386 8.5 2.5V7.5H13.5C13.7761 7.5 14 7.72386 14 8C14 8.27614 13.7761 8.5 13.5 8.5H8.5V13.5C8.5 13.7761 8.27614 14 8 14C7.72386 14 7.5 13.7761 7.5 13.5V8.5H2.5C2.22386 8.5 2 8.27614 2 8C2 7.72386 2.22386 7.5 2.5 7.5H7.5V2.5C7.5 2.22386 7.72386 2 8 2Z"/>
                                </Viewbox>
                                <TextBlock x:Uid="PageMenu_AddToQueue" Margin="8,0,6,0" FontSize="{StaticResource FontSizePageMenuControlText}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <!-- Add to playlist -->
                        <Button Margin="8,0,8,0" Height="36" Command="{x:Bind ViewModel.SelectedDirectoryAddToPlaylistCommand}" CommandParameter="{x:Bind ViewModel.MusicEntriesFiltered, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal">
                                <Viewbox Width="14" Height="14">
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M8 2C8.27614 2 8.5 2.22386 8.5 2.5V7.5H13.5C13.7761 7.5 14 7.72386 14 8C14 8.27614 13.7761 8.5 13.5 8.5H8.5V13.5C8.5 13.7761 8.27614 14 8 14C7.72386 14 7.5 13.7761 7.5 13.5V8.5H2.5C2.22386 8.5 2 8.27614 2 8C2 7.72386 2.22386 7.5 2.5 7.5H7.5V2.5C7.5 2.22386 7.72386 2 8 2Z"/>
                                </Viewbox>
                                <TextBlock x:Uid="PageMenu_AddToPlaylist" Margin="8,0,6,0" FontSize="{StaticResource FontSizePageMenuControlText}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                </Grid>

                <ListView Grid.Row="1" x:Name="FilesListview" Margin="8,24,0,0" ItemsSource="{x:Bind ViewModel.MusicEntriesFiltered, Mode=OneWay}" SelectionMode="Extended" IsMultiSelectCheckBoxEnabled="False" RightTapped="ListView_RightTapped"  BorderThickness="0" ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ContextFlyout>
                        <MenuFlyout>
                            <MenuFlyoutItem x:Uid="ListViewItemContextMenu_Play" Command="{x:Bind ViewModel.FilesSelectedItemsPlayCommand}" CommandParameter="{x:Bind FilesListview.SelectedItems}">
                                <MenuFlyoutItem.Icon>
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12Zm8.856-3.845A1.25 1.25 0 0 0 9 9.248v5.504a1.25 1.25 0 0 0 1.856 1.093l5.757-3.189a.75.75 0 0 0 0-1.312l-5.757-3.189Z"/>
                                </MenuFlyoutItem.Icon>
                                <MenuFlyoutItem.KeyboardAccelerators>
                                    <KeyboardAccelerator Key="Enter" />
                                </MenuFlyoutItem.KeyboardAccelerators>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem x:Uid="ListviewItemContextMenu_AddToPlaylist" Command="{x:Bind ViewModel.FilesAddSelectedItemsToPlaylistCommand}" CommandParameter="{x:Bind FilesListview.SelectedItems}">
                                <MenuFlyoutItem.Icon>
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2Zm0 5a.75.75 0 0 0-.743.648l-.007.102v3.5h-3.5a.75.75 0 0 0-.102 1.493l.102.007h3.5v3.5a.75.75 0 0 0 1.493.102l.007-.102v-3.5h3.5a.75.75 0 0 0 .102-1.493l-.102-.007h-3.5v-3.5A.75.75 0 0 0 12 7Z"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                            <MenuFlyoutItem x:Uid="ListviewItemContextMenu_AddToQueue" Command="{x:Bind ViewModel.FilesAddSelectedItemsToQueueCommand}" CommandParameter="{x:Bind FilesListview.SelectedItems}">
                                <MenuFlyoutItem.Icon>
                                    <PathIcon Width="NaN" Height="NaN" Margin="0" Data="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2Zm0 5a.75.75 0 0 0-.743.648l-.007.102v3.5h-3.5a.75.75 0 0 0-.102 1.493l.102.007h3.5v3.5a.75.75 0 0 0 1.493.102l.007-.102v-3.5h3.5a.75.75 0 0 0 .102-1.493l-.102-.007h-3.5v-3.5A.75.75 0 0 0 12 7Z"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                        </MenuFlyout>
                    </ListView.ContextFlyout>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="mod:NodeFile">
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="0"></ColumnDefinition>
                                    <ColumnDefinition Width="80" MinWidth="80"></ColumnDefinition>
                                    <ColumnDefinition Width="0"></ColumnDefinition>
                                    <ColumnDefinition Width="1*"></ColumnDefinition>
                                    <ColumnDefinition Width="1*"></ColumnDefinition>
                                    <ColumnDefinition Width="Auto"></ColumnDefinition>
                                    <!-- Width="{Binding Width, ElementName=test3}" MinWidth="{Binding MinWidth, ElementName=test3}" MaxWidth="{Binding MaxWidth, ElementName=test3}" -->
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" Width="80">
                                    <Button Margin="4,0,0,0" Height="30" Background="Transparent" BorderThickness="0" Command="{x:Bind ParentViewModel.FilesListviewPlayThisCommand}" CommandParameter="{x:Bind}">
                                        <Viewbox Width="12" Height="12" Margin="0" HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <PathIcon Data="M5.74514 3.06445C5.41183 2.87696 5 3.11781 5 3.50023V12.5005C5 12.8829 5.41182 13.1238 5.74512 12.9363L13.7454 8.43631C14.0852 8.24517 14.0852 7.75589 13.7454 7.56474L5.74514 3.06445ZM4 3.50023C4 2.35298 5.2355 1.63041 6.23541 2.19288L14.2357 6.69317C15.2551 7.26664 15.2551 8.73446 14.2356 9.3079L6.23537 13.8079C5.23546 14.3703 4 13.6477 4 12.5005V3.50023Z" Width="NaN" Height="NaN" Margin="0">
                                            </PathIcon>
                                        </Viewbox>
                                    </Button>
                                    <Button Margin="4,0,0,0" Height="30" Background="Transparent" BorderThickness="0" Command="{x:Bind ParentViewModel.FilesListviewAddThisCommand}" CommandParameter="{x:Bind}">
                                        <Viewbox Width="12" Height="12" HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <PathIcon Data="M8 2C8.27614 2 8.5 2.22386 8.5 2.5V7.5H13.5C13.7761 7.5 14 7.72386 14 8C14 8.27614 13.7761 8.5 13.5 8.5H8.5V13.5C8.5 13.7761 8.27614 14 8 14C7.72386 14 7.5 13.7761 7.5 13.5V8.5H2.5C2.22386 8.5 2 8.27614 2 8C2 7.72386 2.22386 7.5 2.5 7.5H7.5V2.5C7.5 2.22386 7.72386 2 8 2Z" Width="NaN" Height="NaN" Margin="0">
                                            </PathIcon>
                                        </Viewbox>
                                    </Button>
                                </StackPanel>

                                <TextBlock Grid.Column="3" Text="{x:Bind Name, Mode=OneWay}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0" Padding="12,0,0,0" Opacity="0.9">
                                </TextBlock>
                                <TextBlock Grid.Column="4" Text="{x:Bind FilePath, Mode=OneWay}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0" Padding="12,0,0,0" Opacity="0.9">
                            <!--  IsVisible="{Binding $parent[ListBox].((vm:MainViewModel)DataContext).IsFilesColumnHeaderFilePathVisible}" -->
                                </TextBlock>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                    <ListView.ItemContainerStyle>
                        <Style BasedOn="{StaticResource DefaultListViewItemStyle}" TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                            <Setter Property="Height" Value="48" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <!-- not possible in winui3?
                        <Setter Property="IsSelected" Value="{x:Bind IsSelected, Mode=TwoWay}" />
                        -->
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
            </Grid>
        </Grid>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1008" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="HeaderGrid.Margin" Value="48,0,48,0" />
                        <Setter Target="BodyGrid.Margin" Value="44,0,0,0" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="HeaderGrid.Margin" Value="24,0,24,0" />
                        <Setter Target="BodyGrid.Margin" Value="20,0,0,0" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="340" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="HeaderGrid.Margin" Value="16,0,16,0" />
                        <Setter Target="BodyGrid.Margin" Value="13,0,0,0" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="HeaderGrid.Margin" Value="16,0,16,0" />
                        <Setter Target="BodyGrid.Margin" Value="13,0,0,0" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
    </Grid>
</Page>
